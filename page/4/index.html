<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no">
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
<meta name="author" content="Hey-f">


    
    


<meta name="description" content="可爱">
<meta name="keywords" content="半个我">
<meta property="og:type" content="website">
<meta property="og:title" content="不可及">
<meta property="og:url" content="https://wangqiong.me/page/4/index.html">
<meta property="og:site_name" content="不可及">
<meta property="og:description" content="可爱">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="不可及">
<meta name="twitter:description" content="可爱">

<link rel="apple-touch-icon" href="/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="不可及" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.ico">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">


    <style> .article { opacity: 0;} </style>


<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>不可及</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: false
    };
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>





    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?382ac27e195392c0cc8aaf4929019a82";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>


</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Hey-f</a></h1>
        </hgroup>

        
        <p class="header-subtitle">识时务者</p>
        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="https://www.halfmy.com">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:me@halfmy.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="https://github.com/heyfgirl" title="GitHub"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CentOS/">CentOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GO/">GO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Github/">Github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GoPath/">GoPath</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GoRoot/">GoRoot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Http/">Http</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/http/">http</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/">node</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/npm安装/">npm安装</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pgsql/">pgsql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/postgres/">postgres</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rinetd/">rinetd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sequelize/">sequelize</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql/">sql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssh/">ssh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/事务/">事务</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/代理/">代理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/命令/">命令</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/增量备份/">增量备份</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/服务器/">服务器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/端口转发/">端口转发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/管道/">管道</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/锁/">锁</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/防火墙/">防火墙</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://bengbu-yuezhang.github.io/">ZY</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://blog.hanrea.com/">Hanrea</a>
                    
                    </div>
                </section>
                

                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Hey-f</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Hey-f</a></h1>
            </hgroup>
            
            <p class="header-subtitle">识时务者</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="https://www.halfmy.com">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:me@halfmy.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/heyfgirl" title="GitHub"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我">
</nav>
      <div class="body-wrap">
  
    <article id="post-iptables_config" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/11/09/iptables_config/" class="article-date">
      <time datetime="2017-11-09T08:30:49.000Z" itemprop="datePublished">2017-11-09</time>
</a>

 
    <a href="/2017/11/09/iptables_config/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2017/11/09/iptables_config/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/09/iptables_config/">Iptables 安装与设置</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="先检查是否安装了iptables"><a href="#先检查是否安装了iptables" class="headerlink" title="先检查是否安装了iptables"></a>先检查是否安装了iptables</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ service iptables status</span><br></pre></td></tr></table></figure>
<h3 id="安装iptables"><a href="#安装iptables" class="headerlink" title="安装iptables"></a>安装iptables</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y iptables</span><br></pre></td></tr></table></figure>
<h3 id="升级iptables"><a href="#升级iptables" class="headerlink" title="升级iptables"></a>升级iptables</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum update iptables</span><br></pre></td></tr></table></figure>
<h3 id="安装iptables-services"><a href="#安装iptables-services" class="headerlink" title="安装iptables-services"></a>安装iptables-services</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install iptables-services</span><br></pre></td></tr></table></figure>
<hr>
<p>  如果系统本身安装了firewalld服务，需要关闭该服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ 停止firewalld服务</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">$ 禁用firewalld服务</span><br><span class="line">systemctl mask firewalld</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="规则设置"><a href="#规则设置" class="headerlink" title="规则设置"></a>规则设置</h2><h3 id="查看现有规则"><a href="#查看现有规则" class="headerlink" title="查看现有规则"></a>查看现有规则</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -L -n</span><br></pre></td></tr></table></figure>
<h3 id="查看现有规则-1"><a href="#查看现有规则-1" class="headerlink" title="查看现有规则"></a>查看现有规则</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -L -n</span><br></pre></td></tr></table></figure>
<h3 id="查看现有规则-2"><a href="#查看现有规则-2" class="headerlink" title="查看现有规则"></a>查看现有规则</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -L -n</span><br></pre></td></tr></table></figure>
<h3 id="允许来自于lo接口的数据包-本地访问"><a href="#允许来自于lo接口的数据包-本地访问" class="headerlink" title="允许来自于lo接口的数据包(本地访问)"></a>允许来自于lo接口的数据包(本地访问)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A INPUT -i lo -j ACCEPT</span><br></pre></td></tr></table></figure>
<h3 id="开放XXXX端口"><a href="#开放XXXX端口" class="headerlink" title="开放XXXX端口"></a>开放XXXX端口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A INPUT -p tcp --dport XXXX -j ACCEPT</span><br></pre></td></tr></table></figure>
<h3 id="允许ping"><a href="#允许ping" class="headerlink" title="允许ping"></a>允许ping</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A INPUT -p icmp --icmp-type 8 -j ACCEPT</span><br></pre></td></tr></table></figure>
<h3 id="要封停一个IP，使用下面这条命令："><a href="#要封停一个IP，使用下面这条命令：" class="headerlink" title="要封停一个IP，使用下面这条命令："></a>要封停一个IP，使用下面这条命令：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -I INPUT -s ***.***.***.*** -j DROP</span><br></pre></td></tr></table></figure>
<h3 id="要解封一个IP，使用下面这条命令"><a href="#要解封一个IP，使用下面这条命令" class="headerlink" title="要解封一个IP，使用下面这条命令:"></a>要解封一个IP，使用下面这条命令:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -D INPUT -s ***.***.***.*** -j DROP</span><br></pre></td></tr></table></figure>
<h3 id="其他入站一律丢弃"><a href="#其他入站一律丢弃" class="headerlink" title="其他入站一律丢弃"></a>其他入站一律丢弃</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -P INPUT DROP</span><br></pre></td></tr></table></figure>
<h3 id="所有出站一律绿灯"><a href="#所有出站一律绿灯" class="headerlink" title="所有出站一律绿灯"></a>所有出站一律绿灯</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -P OUTPUT ACCEPT</span><br></pre></td></tr></table></figure>
<h3 id="所有转发一律丢弃"><a href="#所有转发一律丢弃" class="headerlink" title="所有转发一律丢弃"></a>所有转发一律丢弃</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -P FORWARD DROP</span><br></pre></td></tr></table></figure>
<h3 id="如果要添加内网ip信任（接受其所有TCP请求）"><a href="#如果要添加内网ip信任（接受其所有TCP请求）" class="headerlink" title="如果要添加内网ip信任（接受其所有TCP请求）"></a>如果要添加内网ip信任（接受其所有TCP请求）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A INPUT -p tcp -s 45.96.174.68 -j ACCEPT</span><br></pre></td></tr></table></figure>
<h3 id="访问外网"><a href="#访问外网" class="headerlink" title="访问外网"></a>访问外网</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure>
<h2 id="防止DDOS攻击"><a href="#防止DDOS攻击" class="headerlink" title="防止DDOS攻击"></a>防止DDOS攻击</h2><h3 id="屏蔽-SYN-RECV-的连接"><a href="#屏蔽-SYN-RECV-的连接" class="headerlink" title="屏蔽 SYN_RECV 的连接"></a>屏蔽 SYN_RECV 的连接</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A FORWARD -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -m limit --limit 1/sec -j ACCEPT</span><br></pre></td></tr></table></figure>
<h3 id="限制IP碎片，每秒钟只允许100个碎片，用来防止DoS"><a href="#限制IP碎片，每秒钟只允许100个碎片，用来防止DoS" class="headerlink" title="限制IP碎片，每秒钟只允许100个碎片，用来防止DoS***"></a>限制IP碎片，每秒钟只允许100个碎片，用来防止DoS***</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A FORWARD -f -m limit --limit 100/sec --limit-burst 100 -j ACCEPT</span><br></pre></td></tr></table></figure>
<h3 id="限制ping包每秒一个，10个后重新开始"><a href="#限制ping包每秒一个，10个后重新开始" class="headerlink" title="限制ping包每秒一个，10个后重新开始"></a>限制ping包每秒一个，10个后重新开始</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A FORWARD -p icmp -m limit --limit 1/sec --limit-burst 10 -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>###限制ICMP包回应请求每秒一个<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A FORWARD -p icmp -m icmp --icmp-type 8 -m limit --limit 1/sec -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<h2 id="删除规则"><a href="#删除规则" class="headerlink" title="删除规则"></a>删除规则</h2><h3 id="删除INPUT规则第三行例子"><a href="#删除INPUT规则第三行例子" class="headerlink" title="删除INPUT规则第三行例子"></a>删除INPUT规则第三行例子</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -D INPUT 3</span><br></pre></td></tr></table></figure>

      <script>
        window.disqusProxy={
          shortname: 'halfmy',
          username: 'halfmy',
          server: 'halfmy.com/disqus',
          port: 80,
          adminAvatar: '/avatars/admin-avatar.jpg',
          identifier: '2017/11/09/iptables_config/',
        };
        window.disqus_config = function () {
          this.page.url = window.location.href;
          this.page.identifier = window.disqusProxy.identifier;
        };
      </script>
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/防火墙/">防火墙</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-ssh_error" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/09/20/ssh_error/" class="article-date">
      <time datetime="2017-09-20T07:34:57.000Z" itemprop="datePublished">2017-09-20</time>
</a>

 
    <a href="/2017/09/20/ssh_error/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2017/09/20/ssh_error/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/20/ssh_error/">SSH无法链接linux</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="SSH无法链接Linux"><a href="#SSH无法链接Linux" class="headerlink" title="SSH无法链接Linux"></a>SSH无法链接Linux</h2><hr>
<p>  某次误操作导致linux虚拟机服务器链接不上，报错/var/empty/sshd must be owned by root and not group or world-writable.</p>
<h2 id="发现是权限问题"><a href="#发现是权限问题" class="headerlink" title="  发现是权限问题"></a>  发现是权限问题</h2><h3 id="问题查找"><a href="#问题查找" class="headerlink" title="问题查找"></a>问题查找</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ rpm -V    检查到ssh软件包正常，但是某个目录属性错误</span><br><span class="line">经查看发现这个目录的属主不是root，所以启动ssh报错</span><br><span class="line">修改为root属主，启动成功</span><br></pre></td></tr></table></figure>
<h3 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chown -R root:root /var/empty/sshd</span><br><span class="line">chmod 744 /var/empty/sshd</span><br><span class="line">service sshd restart</span><br></pre></td></tr></table></figure>
<h3 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h3><p><strong><em> 自己在处理文件权限的时候失误操作，命令中使用了 /xxx 导致将所有文件所有权更改导致 </em></strong></p>

      <script>
        window.disqusProxy={
          shortname: 'halfmy',
          username: 'halfmy',
          server: 'halfmy.com/disqus',
          port: 80,
          adminAvatar: '/avatars/admin-avatar.jpg',
          identifier: '2017/09/20/ssh_error/',
        };
        window.disqus_config = function () {
          this.page.url = window.location.href;
          this.page.identifier = window.disqusProxy.identifier;
        };
      </script>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/linux/">linux</a><a class="article-category-link" href="/categories/ssh/">ssh</a>
    </div>


      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-node_http_flow" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/07/11/node_http_flow/" class="article-date">
      <time datetime="2017-07-11T08:30:49.000Z" itemprop="datePublished">2017-07-11</time>
</a>

 
    <a href="/2017/07/11/node_http_flow/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2017/07/11/node_http_flow/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/11/node_http_flow/">Node.js中Http的从请求到响应</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p><strong><em> Node.js 中，起一个 HTTP server 十分简单，短短数行即可：</em></strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'use stirct'</span></span><br><span class="line"><span class="keyword">const</span> &#123; createServer &#125; = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line">createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.writeHead(<span class="number">200</span>, &#123; <span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span> &#125;)</span><br><span class="line">  res.end(<span class="string">'Hello World\n'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; </span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Listening on port 3000'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl localhost:3000</span><br><span class="line">Hello World</span><br></pre></td></tr></table></figure>
<p>就这么简单，因为 Node.js 把许多细节都已在源码中封装好了，主要代码在 lib/<em>http</em>*.js 这些文件中，现在就让我们照着上述代码，看看从一个 HTTP 请求的到来直到响应，Node.js 都为我们在源码层做了些什么。</p>
<h2 id="HTTP-请求的来到"><a href="#HTTP-请求的来到" class="headerlink" title="HTTP 请求的来到"></a>HTTP 请求的来到</h2><p>在 Node.js 中，若要收到一个 HTTP 请求，首先需要创建一个 http.Server 类的实例，然后监听它的 request 事件。由于 HTTP 协议属于应用层，在下层的传输层通常使用的是 TCP 协议，所以 net.Server 类正是 http.Server 类的父类。具体的 HTTP 相关的部分，是通过监听 net.Server 类实例的 connection 事件封装的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/_http_server.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Server</span>(<span class="params">requestListener</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> Server)) <span class="keyword">return</span> <span class="keyword">new</span> Server(requestListener);</span><br><span class="line">  net.Server.call(<span class="keyword">this</span>, &#123; <span class="attr">allowHalfOpen</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">  <span class="keyword">if</span> (requestListener) &#123;</span><br><span class="line">    <span class="keyword">this</span>.addListener(<span class="string">'request'</span>, requestListener);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">this</span>.addListener(<span class="string">'connection'</span>, connectionListener);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line">util.inherits(Server, net.Server);</span><br></pre></td></tr></table></figure>
<p>这时，则需要一个 HTTP parser 来解析通过 TCP 传输过来的数据：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/_http_server.js</span></span><br><span class="line"><span class="keyword">const</span> parsers = common.parsers;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connectionListener</span>(<span class="params">socket</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">var</span> parser = parsers.alloc();</span><br><span class="line">  parser.reinitialize(HTTPParser.REQUEST);</span><br><span class="line">  parser.socket = socket;</span><br><span class="line">  socket.parser = parser;</span><br><span class="line">  parser.incoming = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>值得一提的是，parser 是从一个“池”中获取的，这个“池”使用了一种叫做 free list（wiki）的数据结构，实现很简单，个人觉得是为了尽可能的对 parser 进行重用，并避免了不断调用构造函数的消耗，且设有数量上限（http 模块中为 1000）：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/freelist.js</span></span><br><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line">exports.FreeList = <span class="function"><span class="keyword">function</span>(<span class="params">name, max, constructor</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.name = name;</span><br><span class="line">  <span class="keyword">this</span>.constructor = <span class="keyword">constructor</span>;</span><br><span class="line">  this.max = max;</span><br><span class="line">  this.list = [];</span><br><span class="line">&#125;;</span><br><span class="line">exports.FreeList.prototype.alloc = function() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.list.length ? <span class="keyword">this</span>.list.pop() :</span><br><span class="line">                            <span class="keyword">this</span>.constructor.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">&#125;;</span><br><span class="line">exports.FreeList.prototype.free = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.list.length &lt; <span class="keyword">this</span>.max) &#123;</span><br><span class="line">    <span class="keyword">this</span>.list.push(obj);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>由于数据是从 TCP 不断推入的，所以这里的 parser 也是基于事件的，很符合 Node.js 的核心思想。使用的是 http-parser 这个库：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/_http_common.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">const</span> binding = process.binding(<span class="string">'http_parser'</span>);</span><br><span class="line"><span class="keyword">const</span> HTTPParser = binding.HTTPParser;</span><br><span class="line"><span class="keyword">const</span> FreeList = <span class="built_in">require</span>(<span class="string">'internal/freelist'</span>).FreeList;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">var</span> parsers = <span class="keyword">new</span> FreeList(<span class="string">'parsers'</span>, <span class="number">1000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> parser = <span class="keyword">new</span> HTTPParser(HTTPParser.REQUEST);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  parser[kOnHeaders] = parserOnHeaders;</span><br><span class="line">  parser[kOnHeadersComplete] = parserOnHeadersComplete;</span><br><span class="line">  parser[kOnBody] = parserOnBody;</span><br><span class="line">  parser[kOnMessageComplete] = parserOnMessageComplete;</span><br><span class="line">  parser[kOnExecute] = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> parser;</span><br><span class="line">&#125;);</span><br><span class="line">exports.parsers = parsers;</span><br><span class="line"><span class="comment">// lib/_http_server.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connectionListener</span>(<span class="params">socket</span>) </span>&#123;</span><br><span class="line">  parser.onIncoming = parserOnIncoming;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>所以一个完整的 HTTP 请求从接收到完全解析，会挨个经历 parser 上的如下事件监听器：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; parserOnHeaders：不断解析推入的请求头数据。</span><br><span class="line">&gt; parserOnHeadersComplete：请求头解析完毕，构造 header 对象，为请求体创建 http.IncomingMessage 实例。</span><br><span class="line">&gt; parserOnBody：不断解析推入的请求体数据。</span><br><span class="line">&gt; parserOnExecute：请求体解析完毕，检查解析是否报错，若报错，直接触发 clientError 事件。若请求为 CONNECT 方法，或带有 Upgrade 头，则直接触发 connect 或 upgrade 事件。</span><br><span class="line">&gt; parserOnIncoming：处理具体解析完毕的请求。</span><br></pre></td></tr></table></figure></p>
<p>所以接下来，我们的关注点自然是 parserOnIncoming 这个监听器，正是这里完成了最终 request 事件的触发，关键步骤代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/_http_server.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connectionListener</span>(<span class="params">socket</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> outgoing = [];</span><br><span class="line">  <span class="keyword">var</span> incoming = [];</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">parserOnIncoming</span>(<span class="params">req, shouldKeepAlive</span>) </span>&#123;</span><br><span class="line">    incoming.push(req);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">var</span> res = <span class="keyword">new</span> ServerResponse(req);</span><br><span class="line">    <span class="keyword">if</span> (socket._httpMessage) &#123; <span class="comment">// 这里判断若为真，则说明 socket 正在被队列中之前的 ServerResponse 实例占用</span></span><br><span class="line">      outgoing.push(res);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      res.assignSocket(socket);</span><br><span class="line">    &#125;</span><br><span class="line">    res.on(<span class="string">'finish'</span>, resOnFinish);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">resOnFinish</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      incoming.shift();</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      <span class="keyword">var</span> m = outgoing.shift();</span><br><span class="line">      <span class="keyword">if</span> (m) &#123;</span><br><span class="line">        m.assignSocket(socket);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    self.emit(<span class="string">'request'</span>, req, res);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看出，对于同一个 socket 发来的请求，源码中分别维护了两个队列，用于缓冲 IncomingMessage 实例和对应的 ServerResponse 实例。先来的 ServerResponse 实例先占用 socket ，监听其 finish 事件，从各自队列中释放该 ServerResponse 实例和对应的 IncomingMessage 实例。</p>
<p>比较绕，以一个简化的图示来总结这部分逻辑：<br><img src="http://dn-cnode.qbox.me/FjJ05SxuHUVoW1hY6bBFA0i9kRUx" alt=""></p>
<h2 id="响应该-HTTP-请求"><a href="#响应该-HTTP-请求" class="headerlink" title="响应该 HTTP 请求"></a>响应该 HTTP 请求</h2><p>到了响应时，事情已经简单许多了，传入的 ServerResponse 已经获取到了 socket。http.ServerResponse 继承于一个内部类 http.OutgoingMessage，当我们调用 ServerResponse#writeHead 时，Node.js 为我们拼凑好了头字符串，并缓存在 ServerResponse 实例内部的 _header 属性中：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/_http_outgoing.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">OutgoingMessage.prototype._storeHeader = <span class="function"><span class="keyword">function</span>(<span class="params">firstLine, headers</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> (headers) &#123;</span><br><span class="line">    <span class="keyword">var</span> keys = <span class="built_in">Object</span>.keys(headers);</span><br><span class="line">    <span class="keyword">var</span> isArray = <span class="built_in">Array</span>.isArray(headers);</span><br><span class="line">    <span class="keyword">var</span> field, value;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = keys.length; i &lt; l; i++) &#123;</span><br><span class="line">      <span class="keyword">var</span> key = keys[i];</span><br><span class="line">      <span class="keyword">if</span> (isArray) &#123;</span><br><span class="line">        field = headers[key][<span class="number">0</span>];</span><br><span class="line">        value = headers[key][<span class="number">1</span>];</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        field = key;</span><br><span class="line">        value = headers[key];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; value.length; j++) &#123;</span><br><span class="line">          storeHeader(<span class="keyword">this</span>, state, field, value[j]);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        storeHeader(<span class="keyword">this</span>, state, field, value);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">this</span>._header = state.messageHeader + CRLF;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>紧接着在调用 ServerResponse#end 时，将数据拼凑在头字符串后，添加对应的尾部，推入 TCP ，具体的写入操作在内部方法 ServerResponse#_writeRaw 中：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/_http_outgoing.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">OutgoingMessage.prototype.end = <span class="function"><span class="keyword">function</span>(<span class="params">data, encoding, callback</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.connection &amp;&amp; data)</span><br><span class="line">    <span class="keyword">this</span>.connection.cork();</span><br><span class="line">  <span class="keyword">var</span> ret;</span><br><span class="line">  <span class="keyword">if</span> (data) &#123;</span><br><span class="line">    <span class="keyword">this</span>.write(data, encoding);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._hasBody &amp;&amp; <span class="keyword">this</span>.chunkedEncoding) &#123;</span><br><span class="line">    ret = <span class="keyword">this</span>._send(<span class="string">'0\r\n'</span> + <span class="keyword">this</span>._trailer + <span class="string">'\r\n'</span>, <span class="string">'binary'</span>, finish);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ret = <span class="keyword">this</span>._send(<span class="string">''</span>, <span class="string">'binary'</span>, finish);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.connection &amp;&amp; data)</span><br><span class="line">    <span class="keyword">this</span>.connection.uncork();</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">OutgoingMessage.prototype._writeRaw = <span class="function"><span class="keyword">function</span>(<span class="params">data, encoding, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> encoding === <span class="string">'function'</span>) &#123;</span><br><span class="line">    callback = encoding;</span><br><span class="line">    encoding = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> connection = <span class="keyword">this</span>.connection;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> connection.write(data, encoding, callback);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong> 到这，一个请求就已经通过 TCP ，发回给客户端了 </strong></p>

      <script>
        window.disqusProxy={
          shortname: 'halfmy',
          username: 'halfmy',
          server: 'halfmy.com/disqus',
          port: 80,
          adminAvatar: '/avatars/admin-avatar.jpg',
          identifier: '2017/07/11/node_http_flow/',
        };
        window.disqus_config = function () {
          this.page.url = window.location.href;
          this.page.identifier = window.disqusProxy.identifier;
        };
      </script>
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/http/">http</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/">node</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-node-buffer-memory-allocation" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/06/13/node-buffer-memory-allocation/" class="article-date">
      <time datetime="2017-06-13T07:34:57.000Z" itemprop="datePublished">2017-06-13</time>
</a>

 
    <a href="/2017/06/13/node-buffer-memory-allocation/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2017/06/13/node-buffer-memory-allocation/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/13/node-buffer-memory-allocation/">Node.js 中 Buffer 的 8KB 池分配规则和固定位数字的读写</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h3 id="8KB-池分配规则"><a href="#8KB-池分配规则" class="headerlink" title="8KB 池分配规则"></a>8KB 池分配规则</h3><p>统计一下，当前版本的 Node.js （v6.0）中可以创建一个新 Buffer 类实例的 API 有：</p>
<ul>
<li>new Buffer() （已不推荐使用，可能会泄露内存中潜在的敏感信息，具体例子可以看这里）</li>
<li>Buffer.alloc()</li>
<li>Buffer.allocUnsafe()（虽然也有泄露内存中敏感信息的可能，但语义上非常明确）</li>
<li>Buffer.from()</li>
<li>Buffer.concat()<br>跟着代码追溯，这些 API 最后都会走进两个内部函数中的一个，来创建 Buffer 实例，这两个内部函数分别是 createBuffer() 和 allocate()：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/buffer.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">Buffer.poolSize = <span class="number">8</span> * <span class="number">1024</span>;</span><br><span class="line"><span class="keyword">var</span> poolSize, poolOffset, allocPool;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createPool</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  poolSize = Buffer.poolSize;</span><br><span class="line">  allocPool = createBuffer(poolSize, <span class="literal">true</span>);</span><br><span class="line">  poolOffset = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">createPool();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createBuffer</span>(<span class="params">size, noZeroFill</span>) </span>&#123;</span><br><span class="line">  flags[kNoZeroFill] = noZeroFill ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> ui8 = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(size);</span><br><span class="line">    <span class="built_in">Object</span>.setPrototypeOf(ui8, Buffer.prototype);</span><br><span class="line">    <span class="keyword">return</span> ui8;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    flags[kNoZeroFill] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">allocate</span>(<span class="params">size</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (size === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> createBuffer(size);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (size &lt; (Buffer.poolSize &gt;&gt;&gt; <span class="number">1</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (size &gt; (poolSize - poolOffset))</span><br><span class="line">      createPool();</span><br><span class="line">    <span class="keyword">var</span> b = allocPool.slice(poolOffset, poolOffset + size);</span><br><span class="line">    poolOffset += size;</span><br><span class="line">    alignPool();</span><br><span class="line">    <span class="keyword">return</span> b;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> createBuffer(size, <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>通过代码可以清楚的看到，若最后创建时，走的是 createBuffer() 函数，则不经过 8KB 池，若走 allocate() 函数，当传入的数据大小小于 Buffer.poolSize 有符号右移 1 位后的结果（相当于将该值除以 2 再向下取整，在本例中，为 4 KB），才会使用到 8KB 池（若当前池剩余空间不足，则创建一个新的，并将当前池指向新池）。</p>
<p>那么现在让我们来看看，这些 API 都走的是哪些方法：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/buffer.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">Buffer.alloc = <span class="function"><span class="keyword">function</span>(<span class="params">size, fill, encoding</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> createBuffer(size);</span><br><span class="line">&#125;;</span><br><span class="line">Buffer.allocUnsafe = <span class="function"><span class="keyword">function</span>(<span class="params">size</span>) </span>&#123;</span><br><span class="line">  assertSize(size);</span><br><span class="line">  <span class="keyword">return</span> allocate(size);</span><br><span class="line">&#125;;</span><br><span class="line">Buffer.from = <span class="function"><span class="keyword">function</span>(<span class="params">value, encodingOrOffset, length</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> (value <span class="keyword">instanceof</span> <span class="built_in">ArrayBuffer</span>)</span><br><span class="line">    <span class="keyword">return</span> fromArrayBuffer(value, encodingOrOffset, length);</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'string'</span>)</span><br><span class="line">    <span class="keyword">return</span> fromString(value, encodingOrOffset);</span><br><span class="line">  <span class="keyword">return</span> fromObject(value);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fromArrayBuffer</span>(<span class="params">obj, byteOffset, length</span>) </span>&#123;</span><br><span class="line">  byteOffset &gt;&gt;&gt;= <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> length === <span class="string">'undefined'</span>)</span><br><span class="line">    <span class="keyword">return</span> binding.createFromArrayBuffer(obj, byteOffset);</span><br><span class="line">  length &gt;&gt;&gt;= <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> binding.createFromArrayBuffer(obj, byteOffset, length);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fromString</span>(<span class="params">string, encoding</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> (length &gt;= (Buffer.poolSize &gt;&gt;&gt; <span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> binding.createFromString(string, encoding);</span><br><span class="line">  <span class="keyword">if</span> (length &gt; (poolSize - poolOffset))</span><br><span class="line">    createPool();</span><br><span class="line">  <span class="keyword">var</span> actual = allocPool.write(string, poolOffset, encoding);</span><br><span class="line">  <span class="keyword">var</span> b = allocPool.slice(poolOffset, poolOffset + actual);</span><br><span class="line">  poolOffset += actual;</span><br><span class="line">  alignPool();</span><br><span class="line">  <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br><span class="line">Buffer.concat = <span class="function"><span class="keyword">function</span>(<span class="params">list, length</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">var</span> buffer = Buffer.allocUnsafe(length);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> buffer;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>挺一目了然的，让我们来总结一下，当在以下情况同时都成立时，创建的新的 Buffer 类实例才会经过内部 8KB 池：</p>
<ul>
<li>通过 Buffer.allocUnsafe，Buffer.concat，Buffer.from（参数不为一个 ArrayBuffer 实例）和 new Buffer（参数不为一个 ArrayBuffer 实例）创建。</li>
<li>传入的数据大小不为 0 。</li>
<li>且传入数据的大小必须小于 4KB 。<h3 id="那些固定位数字读写-API"><a href="#那些固定位数字读写-API" class="headerlink" title="那些固定位数字读写 API"></a>那些固定位数字读写 API</h3>当你在阅读 Buffer 的文档时，看到诸如 Buffer#writeUInt32BE，Buffer#readUInt32BE 这样的 API 时，可能会想到 ES6 规范中的 DateView 类提供的那些方法。其实它们做的事情十分相似，Node.js 项目中甚至还有将这些 API 的底层都替换成原生的 DateView 实例来操作的 PR ，但该 PR 目前已被标记为 stalled ，具体原因大致是：</li>
<li>没有显著的性能提升。</li>
<li>会在实例被初始化后又增加新的属性。</li>
<li>noAssert 参数将会失效。<br>先不管这个 PR ，其实，这些读写操作，若数字的精度在 32 位以下，则对应方法都是由 JavaScript 实现的，十分优雅，利用了 TypeArray 下那些类（Buffer 中使用的是 Uint8Array）的实例中的元素，在位溢出时，会抛弃溢出位的机制。以 writeUInt32LE 和 writeUInt32BE （LE 和 BE 即小端字节序和大端字节序，可以参阅这篇文章）为例，一个 32 位无符号整数需要 4 字节存储，大端字节序时，则第一个元素为直接将传入的 32 位整数无符号右移 24 位，获取到原最左的 8 位，抛弃当下左边的所有位。以此类推，第二个元素为无符号右移 16 位，第三个元素为 8 位，第四个元素无需移动（小端字节序则相反）：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Buffer.prototype.writeUInt32BE = <span class="function"><span class="keyword">function</span>(<span class="params">value, offset, noAssert</span>) </span>&#123;</span><br><span class="line">  value = +value;</span><br><span class="line">  offset = offset &gt;&gt;&gt; <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (!noAssert)</span><br><span class="line">    checkInt(<span class="keyword">this</span>, value, offset, <span class="number">4</span>, <span class="number">0xffffffff</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">this</span>[offset] = (value &gt;&gt;&gt; <span class="number">24</span>);</span><br><span class="line">  <span class="keyword">this</span>[offset + <span class="number">1</span>] = (value &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">  <span class="keyword">this</span>[offset + <span class="number">2</span>] = (value &gt;&gt;&gt; <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">this</span>[offset + <span class="number">3</span>] = value;</span><br><span class="line">  <span class="keyword">return</span> offset + <span class="number">4</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>读操作与之对应，使用了无符号左移后腾出空位再进行 | 操作合并：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Buffer.prototype.readUInt32BE = <span class="function"><span class="keyword">function</span>(<span class="params">offset, noAssert</span>) </span>&#123;</span><br><span class="line">  offset = offset &gt;&gt;&gt; <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (!noAssert)</span><br><span class="line">    checkOffset(offset, <span class="number">4</span>, <span class="keyword">this</span>.length);</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">this</span>[offset] * <span class="number">0x1000000</span>) +</span><br><span class="line">      ((<span class="keyword">this</span>[offset + <span class="number">1</span>] &lt;&lt; <span class="number">16</span>) |</span><br><span class="line">      (<span class="keyword">this</span>[offset + <span class="number">2</span>] &lt;&lt; <span class="number">8</span>) |</span><br><span class="line">      <span class="keyword">this</span>[offset + <span class="number">3</span>]);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>其中的 (this[offset] * 0x1000000) + 相当于 this[offset] &lt;&lt; 24 | 。</p>

      <script>
        window.disqusProxy={
          shortname: 'halfmy',
          username: 'halfmy',
          server: 'halfmy.com/disqus',
          port: 80,
          adminAvatar: '/avatars/admin-avatar.jpg',
          identifier: '2017/06/13/node-buffer-memory-allocation/',
        };
        window.disqus_config = function () {
          this.page.url = window.location.href;
          this.page.identifier = window.disqusProxy.identifier;
        };
      </script>
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-deep-copy" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/05/26/deep-copy/" class="article-date">
      <time datetime="2017-05-26T07:24:59.000Z" itemprop="datePublished">2017-05-26</time>
</a>

 
    <a href="/2017/05/26/deep-copy/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2017/05/26/deep-copy/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/05/26/deep-copy/">JavaScript 的深复制</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="第三方库的实现"><a href="#第三方库的实现" class="headerlink" title="第三方库的实现"></a>第三方库的实现</h2><h3 id="Underscore-——-clone"><a href="#Underscore-——-clone" class="headerlink" title="Underscore —— _.clone()"></a>Underscore —— _.clone()</h3><p>在 Underscore 中有这样一个方法：_.clone()，这个方法实际上是一种浅复制 (shallow-copy)，所有嵌套的对象和数组都是直接复制引用而并没有进行深复制。来看一下例子应该会更加直观：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = &#123;</span><br><span class="line">    a: <span class="number">1</span>,</span><br><span class="line">    b: &#123; <span class="attr">z</span>: <span class="number">0</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> y = _.clone(x);</span><br><span class="line"></span><br><span class="line">y === x       <span class="comment">// false</span></span><br><span class="line">y.b === x.b   <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">x.b.z = <span class="number">100</span>;</span><br><span class="line">y.b.z         <span class="comment">// 100</span></span><br></pre></td></tr></table></figure></p>
<p>让我们来看一下 Underscore 的源码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create a (shallow-cloned) duplicate of an object.</span></span><br><span class="line">_.clone = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!_.isObject(obj)) <span class="keyword">return</span> obj;</span><br><span class="line">  <span class="keyword">return</span> _.isArray(obj) ? obj.slice() : _.extend(&#123;&#125;, obj);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>如果目标对象是一个数组，则直接调用数组的slice()方法，否则就是用_.extend()方法。想必大家对extend()方法不会陌生，它的作用主要是将从第二个参数开始的所有对象，按键值逐个赋给第一个对象。而在 jQuery 中也有类似的方法。关于 Underscore 中的 _.extend() 方法的实现可以参考 underscore.js #L1006。</p>
<p>Underscore 的 clone() 不能算作深复制，但它至少比直接赋值来得“深”一些，它创建了一个新的对象。另外，你也可以通过以下比较 tricky 的方法来完成单层嵌套的深复制：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _ = <span class="built_in">require</span>(<span class="string">'underscore'</span>);</span><br><span class="line"><span class="keyword">var</span> a = [&#123;<span class="attr">f</span>: <span class="number">1</span>&#125;, &#123;<span class="attr">f</span>:<span class="number">5</span>&#125;, &#123;<span class="attr">f</span>:<span class="number">10</span>&#125;];</span><br><span class="line"><span class="keyword">var</span> b = _.map(a, _.clone);       <span class="comment">// &lt;----</span></span><br><span class="line">b[<span class="number">1</span>].f = <span class="number">55</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(a));  <span class="comment">// [&#123;"f":1&#125;,&#123;"f":5&#125;,&#123;"f":10&#125;]</span></span><br></pre></td></tr></table></figure>
<h3 id="jQuery-——-clone-extend"><a href="#jQuery-——-clone-extend" class="headerlink" title="jQuery —— $.clone() / $.extend()"></a>jQuery —— $.clone() / $.extend()</h3><p>在 jQuery 中也有这么一个叫 $.clone() 的方法，可是它并不是用于一般的 JS 对象的深复制，而是用于 DOM 对象。这不是这篇文章的重点，所以感兴趣的同学可以参考jQuery的文档。与 Underscore 类似，我们也是可以通过 $.extend() 方法来完成深复制。值得庆幸的是，我们在 jQuery 中可以通过添加一个参数来实现递归extend。调用$.extend(true, {}, …)就可以实现深复制啦，参考下面的例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = &#123;</span><br><span class="line">    a: <span class="number">1</span>,</span><br><span class="line">    b: &#123; <span class="attr">f</span>: &#123; <span class="attr">g</span>: <span class="number">1</span> &#125; &#125;,</span><br><span class="line">    c: [ <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> ]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> y = $.extend(&#123;&#125;, x),          <span class="comment">//shallow copy</span></span><br><span class="line">    z = $.extend(<span class="literal">true</span>, &#123;&#125;, x);    <span class="comment">//deep copy</span></span><br><span class="line"></span><br><span class="line">y.b.f === x.b.f       <span class="comment">// true</span></span><br><span class="line">z.b.f === x.b.f       <span class="comment">// false</span></span><br></pre></td></tr></table></figure>
<p>在 jQuery的源码 - src/core.js #L121 文件中我们可以找到$.extend()的实现，也是实现得比较简洁，而且不太依赖于 jQuery 的内置函数，稍作修改就能拿出来单独使用。</p>
<h3 id="lodash-——-clone-cloneDeep"><a href="#lodash-——-clone-cloneDeep" class="headerlink" title="lodash —— _.clone() / _.cloneDeep()"></a>lodash —— _.clone() / _.cloneDeep()</h3><p>在lodash中关于复制的方法有两个，分别是<em>.clone()和</em>.cloneDeep()。其中<em>.clone(obj, true)等价于</em>.cloneDeep(obj)。使用上，lodash和前两者并没有太大的区别，但看了源码会发现，Underscore 的实现只有30行左右，而 jQuery 也不过60多行。可 lodash 中与深复制相关的代码却有上百行，这是什么道理呢？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> $ = <span class="built_in">require</span>(<span class="string">"jquery"</span>),</span><br><span class="line">  _ = <span class="built_in">require</span>(<span class="string">"lodash"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arr = <span class="keyword">new</span> <span class="built_in">Int16Array</span>(<span class="number">5</span>),</span><br><span class="line">    obj = &#123; <span class="attr">a</span>: arr &#125;,</span><br><span class="line">    obj2;</span><br><span class="line">arr[<span class="number">0</span>] = <span class="number">5</span>;</span><br><span class="line">arr[<span class="number">1</span>] = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. jQuery</span></span><br><span class="line">obj2 = $.extend(<span class="literal">true</span>, &#123;&#125;, obj);</span><br><span class="line"><span class="built_in">console</span>.log(obj2.a);                            <span class="comment">// [5, 6, 0, 0, 0]</span></span><br><span class="line"><span class="built_in">Object</span>.prototype.toString.call(obj2);           <span class="comment">// [object Int16Array]</span></span><br><span class="line">obj2.a[<span class="number">0</span>] = <span class="number">100</span>;</span><br><span class="line"><span class="built_in">console</span>.log(obj);                               <span class="comment">// [100, 6, 0, 0, 0]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//此处jQuery不能正确处理Int16Array的深复制！！！</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. lodash</span></span><br><span class="line">obj2 = _.cloneDeep(obj);                       </span><br><span class="line"><span class="built_in">console</span>.log(obj2.a);                            <span class="comment">// [5, 6, 0, 0, 0]</span></span><br><span class="line"><span class="built_in">Object</span>.prototype.toString.call(arr2);           <span class="comment">// [object Int16Array]</span></span><br><span class="line">obj2.a[<span class="number">0</span>] = <span class="number">100</span>;</span><br><span class="line"><span class="built_in">console</span>.log(obj);                               <span class="comment">// [5, 6, 0, 0, 0]</span></span><br></pre></td></tr></table></figure>
<p>通过上面这个例子可以初见端倪，jQuery 无法正确深复制 JSON 对象以外的对象，而我们可以从下面这段代码片段可以看出 lodash 花了大量的代码来实现 ES6 引入的大量新的标准对象。更厉害的是，lodash 针对存在环的对象的处理也是非常出色的。因此相较而言，lodash 在深复制上的行为反馈比前两个库好很多，是更拥抱未来的一个第三方库。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** `Object#toString` result references. */</span></span><br><span class="line"><span class="keyword">var</span> argsTag = <span class="string">'[object Arguments]'</span>,</span><br><span class="line">    arrayTag = <span class="string">'[object Array]'</span>,</span><br><span class="line">    boolTag = <span class="string">'[object Boolean]'</span>,</span><br><span class="line">    dateTag = <span class="string">'[object Date]'</span>,</span><br><span class="line">    errorTag = <span class="string">'[object Error]'</span>,</span><br><span class="line">    funcTag = <span class="string">'[object Function]'</span>,</span><br><span class="line">    mapTag = <span class="string">'[object Map]'</span>,</span><br><span class="line">    numberTag = <span class="string">'[object Number]'</span>,</span><br><span class="line">    objectTag = <span class="string">'[object Object]'</span>,</span><br><span class="line">    regexpTag = <span class="string">'[object RegExp]'</span>,</span><br><span class="line">    setTag = <span class="string">'[object Set]'</span>,</span><br><span class="line">    stringTag = <span class="string">'[object String]'</span>,</span><br><span class="line">    weakMapTag = <span class="string">'[object WeakMap]'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arrayBufferTag = <span class="string">'[object ArrayBuffer]'</span>,</span><br><span class="line">    float32Tag = <span class="string">'[object Float32Array]'</span>,</span><br><span class="line">    float64Tag = <span class="string">'[object Float64Array]'</span>,</span><br><span class="line">    int8Tag = <span class="string">'[object Int8Array]'</span>,</span><br><span class="line">    int16Tag = <span class="string">'[object Int16Array]'</span>,</span><br><span class="line">    int32Tag = <span class="string">'[object Int32Array]'</span>,</span><br><span class="line">    uint8Tag = <span class="string">'[object Uint8Array]'</span>,</span><br><span class="line">    uint8ClampedTag = <span class="string">'[object Uint8ClampedArray]'</span>,</span><br><span class="line">    uint16Tag = <span class="string">'[object Uint16Array]'</span>,</span><br><span class="line">    uint32Tag = <span class="string">'[object Uint32Array]'</span>;</span><br></pre></td></tr></table></figure></p>
<h2 id="借助-JSON-全局对象"><a href="#借助-JSON-全局对象" class="headerlink" title="借助 JSON 全局对象"></a>借助 JSON 全局对象</h2><p>相比于上面介绍的三个库的做法，针对纯 JSON 数据对象的深复制，使用 JSON 全局对象的 parse 和 stringify 方法来实现深复制也算是一个简单讨巧的方法。然而使用这种方法会有一些隐藏的坑，它能正确处理的对象只有 Number, String, Boolean, Array, 扁平对象，即那些能够被 json 直接表示的数据结构。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">jsonClone</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">JSON</span>.parse(<span class="built_in">JSON</span>.stringify(obj));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> clone = jsonClone(&#123; <span class="attr">a</span>:<span class="number">1</span> &#125;);</span><br></pre></td></tr></table></figure></p>

      <script>
        window.disqusProxy={
          shortname: 'halfmy',
          username: 'halfmy',
          server: 'halfmy.com/disqus',
          port: 80,
          adminAvatar: '/avatars/admin-avatar.jpg',
          identifier: '2017/05/26/deep-copy/',
        };
        window.disqus_config = function () {
          this.page.url = window.location.href;
          this.page.identifier = window.disqusProxy.identifier;
        };
      </script>
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-http_web_server" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/07/02/http_web_server/" class="article-date">
      <time datetime="2016-07-02T08:30:49.000Z" itemprop="datePublished">2016-07-02</time>
</a>

 
    <a href="/2016/07/02/http_web_server/#comments" title="查看评论">
        <i class="fa fa-comments-o" aria-hidden="true"></i>
        <span class="count-comment"></span>
        
        
            <span class="disqus-comment-count" data-disqus-identifier="2016/07/02/http_web_server/"></span>
        
    </a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/02/http_web_server/">Http通信协议</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h3 id="Http协议是什么"><a href="#Http协议是什么" class="headerlink" title="Http协议是什么"></a>Http协议是什么</h3><p><strong> 协议是指计算机通信网络中两台计算机之间进行通信所必须共同遵守的法定活规则，超文本传输协议（HTTP）是一种通信协议，它允许将超文本标记语言文档从web服务器传送到客户端的浏览器。 </strong></p>
<h3 id="HTTP协议的特点"><a href="#HTTP协议的特点" class="headerlink" title="HTTP协议的特点"></a>HTTP协议的特点</h3><ul>
<li>支持客户端/服务器模式</li>
<li>无状态，此处的无状态是指对事务无记忆能力，如果后续需要这些信息，那么需要重新传递获取数据。</li>
<li>简单快速，客户端只需要发送请求方法和路径到服务端，请求方式有get,post,head,put,delete,options,trace,关于此处的解释移步此处.</li>
<li>无连接，指每次处理只限制处理一个连接.服务器处理完客户的请求，并收到客户的应答后，即断开连接。采用这种方式可以节省传输时间。</li>
<li>灵活，HTTP请求允许发送任意类型的数据。当前请求类型可以查看Content-Type</li>
</ul>
<h3 id="HTTP请求"><a href="#HTTP请求" class="headerlink" title="HTTP请求"></a>HTTP请求</h3><blockquote>
<p>1.<strong>Date头域</strong><br><em>Date头域表示消息发送的时间，时间的描述格式由rfc822定义。例如，Date:Mon,31Dec200104:25:57GMT。Date描述的时间表示世界标准时，换算成本地时间，需要知道用户所在的时区。</em><br>2.<strong>Pragma头域</strong><br><em>Pragma头域用来包含实现特定的指令，最常用的是Pragma:no-cache。在HTTP/1.1协议中，它的含义和Cache- Control:no-cache相同。</em><br>3.<strong>Host头域</strong><br><em>Host头域指定请求资源的Intenet主机和端口号，必须表示请求url的原始服务器或网关的位置。HTTP/1.1请求必须包含主机头域，否则系统会以400状态码返回。</em><br>4.<strong>Referer头域</strong><br><em>Referer 头域允许客户端指定请求uri的源资源地址，这可以允许服务器生成回退链表，可用来登陆、优化cache等。他也允许废除的或错误的连接由于维护的目的被 追踪。如果请求的uri没有自己的uri地址，Referer不能被发送。如果指定的是部分uri地址，则此地址应该是一个相对地址。</em><br>5.<strong>Cache-Control头域 指定请求和响应遵循的缓存机制</strong><br><em>Cache- Control指定请求和响应遵循的缓存机制。在请求消息或响应消息中设置 Cache-Control并不会修改另一个消息处理过程中的缓存处理过程。请求时的缓存指令包括no-cache、no-store、max-age、 max-stale、min-fresh、only-if-cached，响应消息中的指令包括public、private、no-cache、no- store、no-transform、must-revalidate、proxy-revalidate、max-age</em></p>
<ul>
<li>Public指示响应可被任何缓存区缓存。 </li>
<li>Private指示对于单个用户的整个或部分响应消息，不能被共享缓存处理。这允许服务器仅仅描述当用户的部分响应消息，此响应消息对于其他用户的请求无效。 </li>
<li>no-cache指示请求或响应消息不能缓存 </li>
<li>no-store用于防止重要的信息被无意的发布。在请求消息中发送将使得请求和响应消息都不使用缓存。</li>
<li>max-age指示客户机可以接收生存期不大于指定时间（以秒为单位）的响应。 </li>
<li>min-fresh指示客户机可以接收响应时间小于当前时间加上指定时间的响应。 </li>
<li>max-stale指示客户机可以接收超出超时期间的响应消息。如果指定max-stale消息的值，那么客户机可以接收超出超时期指定值之内的响应消息<br>6.<strong>Range头域</strong><br><em>Range头域可以请求实体的一个或者多个子范围。例如:</em></li>
<li>表示头500个字节：bytes=0-499</li>
<li>表示第二个500字节：bytes=500-999 </li>
<li>表示最后500个字节：bytes=-500 </li>
<li>表示500字节以后的范围：bytes=500- </li>
<li>第一个和最后一个字节：bytes=0-0,-1 </li>
<li>同时指定几个范围：bytes=500-600,601-999 </li>
<li>但是服务器可以忽略此请求头，如果无条件GET包含Range请求头，响应会以状态码206（PartialContent）返回而不是以200 （OK）。<br>7.<strong>User-Agent头域</strong><br><em>User-Agent头域的内容包含发出请求的用户信息。HTTP- Version表示支持的HTTP版本，例如为HTTP/1.1。Status- Code是一个三个数字的结果代码。Reason-Phrase给Status-Code提供一个简单的文本描述。Status-Code主要用于机器自 动识别，Reason-Phrase主要用于帮助用户理解。Status-Code的第一个数字定义响应的类别，后两个数字没有分类的作用。浏览器类型，如果Servlet返回的内容与浏览器类型有关则该值非常有用。</em></li>
</ul>
</blockquote>
<h3 id="HTTP响应"><a href="#HTTP响应" class="headerlink" title="HTTP响应"></a>HTTP响应</h3><blockquote>
<p>响应消息行：包含协议/版本，响应状态码，对响应状态码的描述（一切正常）<br>响应消息头：服务器与客户端通信的暗码，告诉客户端该怎么执行某些操作<br>响应消息正文：和网页右键“查看源码”看到的内容一样<br>1.<strong>状态行（HTTP/1.1 200 OK）</strong></p>
<ul>
<li>协议版本号。</li>
<li>状态代码：状态代码由3位数字组成，表示请求是否被理解或被满足。<ul>
<li>200   OK    客户端请求成功</li>
<li>400   Bad Request   由于客户端请求有语法错误，不能被服务器所理解。</li>
<li>301   （302）   重定向—要完成请求必须进行更进一步的操作。</li>
<li>304   缓存</li>
<li>401   Unauthonzed   请求未经授权。这个状态代码必须和WWW-Authenticate报头域一起使用</li>
<li>403   Forbidden   服务器收到请求，但是拒绝提供服务。服务器通常会在响应正文中给出不提供服务的原因()</li>
<li>404   Not Found   请求的资源不存在，例如，输入了错误的URL。</li>
<li>500   Internal Server Error 服务器发生不可预期的错误，导致无法完成客户端的请求。</li>
<li>503   Service Unavailable   服务器当前不能够处理客户端的请求，在一段时间之后，服务器可能会恢复正常。</li>
</ul>
</li>
<li>状态描述：状态描述给出了关于状态代码的简短的文字描述。<br>2.<strong>响应头</strong><br>Location：响应报头域用于重定向接受者到一个新的位置。<br>Server： 响应报头域包含了服务器用来处理请求的软件信息。0</li>
</ul>
</blockquote>

      <script>
        window.disqusProxy={
          shortname: 'halfmy',
          username: 'halfmy',
          server: 'halfmy.com/disqus',
          port: 80,
          adminAvatar: '/avatars/admin-avatar.jpg',
          identifier: '2016/07/02/http_web_server/',
        };
        window.disqus_config = function () {
          this.page.url = window.location.href;
          this.page.identifier = window.disqusProxy.identifier;
        };
      </script>
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Http/">Http</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/">web</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/3/">&laquo; 往上翻</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2015-2020 Hey-f
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a><!--  <i class="fa fa-heart animated infinite pulse"></i>  -->
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style="display:none">
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style="display:none">
                        <span id="page-visit" title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 6;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>


    

    
        <script id="dsq-count-scr" src="//halfmy.disqus.com/count.js" async></script>
        <script>
            if ($(".left-col").is(":visible")) {
                var $disqusCount = $(".disqus-comment-count");
                $disqusCount.bind("DOMNodeInserted", function(e) {
                    var num = $(this).text().replace(/[^0-9]/ig,"");
                    if (num > 0) {
                        $(this).siblings(".count-comment").text(num);
                    }
                    $(this).remove();
                })
            } else {
                $(".disqus-comment-count").remove();
            }
        </script>
     




<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
             tags: ".article-tag a", 
             categories: ".article-category a, a.tag-list-link", 
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>